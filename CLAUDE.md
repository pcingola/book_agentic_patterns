# CLAUDE.md

Full documentation: `docs/agentic_patterns.md` (main file) and `docs/agentic_patterns/` (detail files). Also available as `llms.txt` / `llms-full.txt` at the project root (generated by `scripts/llms_txt.sh`).

## Project Overview

Repository for the book "Agentic Patterns" -- a proof-of-concept agentic platform teaching architectural principles for AI agent systems. Targets software engineers and ML practitioners. All code uses PydanticAI. Book is written in markdown with each chapter in its own directory.

## Repository Structure

```
book_agentic_patterns/
├── chapters/           # Book chapters (markdown files)
├── agentic_patterns/   # Python code examples and core library
│   ├── core/          # Reusable infrastructure
│   ├── agents/        # Domain-specific agents (db_catalog, vocabulary, nl2sql, openapi, etc.)
│   ├── a2a/           # A2A server implementations (thin wrappers over agents + MCP)
│   ├── toolkits/      # Business logic (no framework dependency)
│   ├── tools/         # PydanticAI agent tool wrappers
│   ├── mcp/           # MCP server thin wrappers
│   ├── examples/      # Code examples by chapter
│   └── testing/       # Testing utilities for agents
├── scripts/            # Build, validation, lint scripts
├── tests/              # Tests (unit/ and integration/ subdirectories)
├── prompts/            # Prompt templates (markdown files)
├── data/               # Runtime data (db/, workspaces/)
├── docs/               # Design and reference documents
└── output/             # Generated book output (book.md, PDF)
```

## Conventions

**Chapters**: All under `chapters/`. Each directory has a `chapter.md` index linking to section files. Images in `img/` subdirectory. Heading levels: `#` for chapter titles, `##` for section titles, `###` and below for sub-sections. Master index in `chapters.md` at root.

**Code organization**: All code in `agentic_patterns/`. Examples under `agentic_patterns/examples/` in directories matching chapters. Core utilities in `agentic_patterns/core/`.

**Notebooks**: NEVER call `set_user_session()` in notebooks -- contextvars have defaults in `core/config/config.py`. `set_user_session()` is only called at real request boundaries (middleware, MCP handlers).

**Prompts**: Store in `prompts/` as markdown files. Load via `load_prompt()` from `core/prompt.py` (supports `{% include %}` and `{variable}` substitution). Reusable blocks in `prompts/shared/`.

**Images**: Use compressed PNGs or SVGs. Large images bloat git history.

**References**: All citations in a `references.md` file.

## Three-Layer Architecture

```
toolkits/*          Business logic. Pure Python: models, operations, I/O.
    |
    +-> tools/*             PydanticAI agent tool wrappers (get_all_tools()).
    +-> mcp/*/tools.py      MCP server thin wrappers (ctx, @mcp.tool(), error conversion).
```

Connectors (`core/connectors/`) are for data source access. Toolkits are for domain logic, operations, services. Each tool file exposes `get_all_tools()` returning plain functions for `Agent(tools=[...])`.

## Library Documentation

For detailed documentation of `core/`, `agents/`, `mcp/`, `a2a/`, `toolkits/`, `tools/`, and `testing/`, see `docs/agentic_patterns.md` and its linked detail files in `docs/agentic_patterns/`.

## Scripts

All scripts source `config.sh` (sets PROJECT_DIR, loads .env, activates .venv, sets PYTHONPATH):

`make.sh` (book compilation), `test.sh` / `test_unit.sh` / `test_integration.sh`, `evals.sh`, `lint.sh`, `llms_txt.sh` (generate `llms.txt` and `llms-full.txt` from `docs/agentic_patterns*`), `release.sh` (lint, tests, llms_txt, clean notebooks; `--bump <version>` to update version), `db_ingest_bookstore_sqlite.sh`, `annotate_schema.sh`, `download_vocabularies.sh`, `ingest_openapi.sh`, `launch_infrastructure.sh` (MCP + A2A servers), `clean_notebooks.sh`.

## Configuration

**config.yaml**: Named model configs (default, fast, azure_gpt4, bedrock_claude, etc.) with provider, credentials, timeout. Pretty much everything is configured here, except the things that frameworks force us to keep in `.env` (CHAINLIT_AUTH_SECRET is probably the only exception)

**.env**: Only things that must be in environment variables for framework compatibility (e.g. `CHAINLIT_AUTH_SECRET` for Chainlit). Everything else MUST be in `config.yaml`

**pyproject.toml**: Dependencies and console scripts (`doctors`, `evals`, `manage-users`, `annotate-schema`, `ingest-openapi`, `build-repl-image`).

**apis.yaml**: OpenAPI specs with `${VAR}` env expansion.

## Reference Documentation (`docs/`)

Consult these when working on related topics: `pydantic-ai.md`, `mcp.md`, `fastmcp.md`, `a2a_specification.md`, `agui.md`, `skills_specification.md`, `tasks.md`, `mcp_requirements.md`, `a2a_requirements.md`. Each links to detailed sections in subdirectories.
